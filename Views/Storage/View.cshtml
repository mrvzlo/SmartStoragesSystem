@model SmartKitchen.Models.StorageDescription
@{
    ViewBag.Title = Model.Name;
}
<div class="h4 text-center">@ViewBag.Title</div>
@{ Html.RenderAction("_AddProduct", "Cell", new { storage = Model.Id });}
<div class="text-center table-responsive m-0 big-border" style="background-color: #@Model.Type.Background">
    @if (Model.Products.Count == 0)
    {
        <div class="alert m-0 h3">This storage is empty now</div>
    }
    else
    {
        <table class="w-100 table table-hover table-borderless p-0 m-0">
            <tr>
                <th style="width: 25%">Name</th>
                <th style="width: 25%">Category</th>
                <th style="width: 25%">Safety</th>
                <th style="width: 25%">Amount</th>
            </tr>
            @foreach (var product in Model.Products)
            {
            <tr id="@product">
            </tr>
            }
            <tr id="loading">
                <td colspan="4" class="font-weight-bold">Loading</td>
            </tr>
        </table>
    }
</div>
@{ Html.RenderAction("DateUpdatePre", "Cell");}
@{ Html.RenderAction("AmountUpdatePre", "Cell");}
@section scripts{
<script>
        var cellId;

        function showDatePicker(product, productName) {
            cellId = product;
            var name = $("#name_" + cellId).text();
            $('#DateModalLabel').text("Choose expiration date for " + name);
        }

        function showAmountPicker(product, productName) {
            cellId = product;
            var name = $("#name_" + cellId).text();
            $('#AmountModalLabel').text("Choose amount of " + name);
        }

        $("#Month").change(function () {
            UpdateDaysinMonth();
        });

        $("#Year").change(function () {
            UpdateDaysinMonth();
        });

        $("#Day").change(function () {
            UpdateDaysinMonth();
        });

        function UpdateDaysinMonth() {
            var Month = $("#Month").val();
            var max = 31;
            if (Month == 4 || Month == 6 || Month == 9 || Month == 11) max = 30;
            if (Month == 2) {
                if ($("#Year").val() % 4 == 0) max = 29;
                else max = 28;
            }

            $("#Day").attr({
                "max": max
            });
            if ($("#Day").val() > max) $("#Day").val(max);
        }

        function DateUpdate() {
            var Day = $("#Day").val();
            var Month = $("#Month").val();
            var Year = $("#Year").val();
            var newDate = Day + "/" + Month + "/" + Year;
            $.ajax({
                url: '@Url.Action("DateUpdate", "Cell")?cell=' + cellId + '&dateStr=' + newDate,
                success: function(data) {
                    document.getElementById(cellId).innerHTML = data;
                }
            });
        }

        function changeProductAmount(amount) {
            $.ajax({
                url: '@Url.Action("SetAmount", "Cell")?cell=' + cellId + '&amount=' + amount,
                success: function(data) {
                    document.getElementById(cellId).innerHTML = data;
                }
            });
        }

        function removeProduct() {
            var name = $("#name_" + cellId).text();
            if (confirm(name + " will be removed")) {
                $.ajax({
                    url: '@Url.Action("Remove", "Cell")?cellId=' + cellId,
                    success: function() {
                        document.getElementById(cellId).outerHTML = "";
                    }
                });
            }
        }

        function getProduct(product) {
            $.ajax({
                url: '@Url.Action("Description", "Cell")?cell=' + product,
                success: function(data) {
                    document.getElementById(product).outerHTML = data;
                }
            });
        }

        function inputChange(id, value) {
            id = "#" + id;
            var max = $(id).attr('max');
            var min = $(id).attr('min');
            var val = $(id).val();
            var newVal = Number(val) + value;
            if (newVal > max) newVal = max;
            else if (newVal < min) newVal = min;
            $(id).val(newVal);
            UpdateDaysinMonth();
        }

        function setTodayDate() {
            var date = new Date();
            $("#Month").val(date.getMonth() + 1);
            $("#Day").val(date.getDate());
            $("#Year").val(date.getFullYear());
        }

        $(function() {
            @foreach (var product in Model.Products)
            {
                    @: getProduct(@product);
            }
            $("#loading").remove();
            UpdateDaysinMonth();
            $("#Month").attr({
                "max": 12,
                "min": 1
            });
            $("#Day").attr({
                "min": 1
            });
            $("#Year").attr({
                "min": (new Date()).getFullYear()
            });
            setTodayDate();
        });
</script>
}